# Story Data Products Schema Specification

This document defines the JSON schemas for story-specific data products that feed LLM-based narrative generation. These schemas form the contract between the Python story tools and the LLM story generator.

## Overview

Story data products are derived from the web bundle and provide structured, machine-readable inputs optimised for LLM narrative generation. They are generated by:

```bash
agentzero export-story --run-dir runs/<run_id> --out runs/<run_id>/story/
```

### Story Data Structure

```
runs/<run_id>/story/
├── story_context.json       # High-level context for the story
├── headline_metrics.json    # Key numbers for the narrative
├── drivers.json             # Factors driving the results
├── agent_summary.json       # Aggregated agent behaviour
├── scenario_comparison.json # Comparison with baseline (if scenario)
└── caveats.json             # Mandatory limitations/warnings
```

---

## 1. story_context.json

High-level context for story generation. Provides the LLM with essential metadata to frame the narrative.

### Schema

```typescript
interface StoryContext {
  /** Unique run identifier */
  run_id: string;
  
  /** Target audience for the narrative */
  audience: 'generalist' | 'technical' | 'expert';
  
  /** Scenario name (null for baseline runs) */
  scenario_name: string | null;
  
  /** Baseline assumptions pack name */
  baseline_name: string;
  
  /** Simulation year range */
  years: {
    start: number;
    end: number;
  };
  
  /** Whether this is a scenario run (vs baseline) */
  is_scenario_run: boolean;
}
```

### Example

```json
{
  "run_id": "run_b3f7a2c1",
  "audience": "technical",
  "scenario_name": "high_ambition_2050",
  "baseline_name": "baseline_v1.0",
  "years": {
    "start": 2024,
    "end": 2050
  },
  "is_scenario_run": true
}
```

### Usage Notes

- `audience` determines vocabulary complexity and technical detail level
- `is_scenario_run` triggers comparative narrative structure
- `years` provides temporal framing for the narrative

---

## 2. headline_metrics.json

Key numbers that anchor the story narrative. These are the "headline" figures that should be prominently featured.

### Schema

```typescript
interface HeadlineMetrics {
  /** Total emissions over simulation period */
  total_emissions: {
    value: number;
    unit: string;
    trend: 'up' | 'down' | 'stable';
    /** Percentage change from baseline (present for scenario runs) */
    delta_percent?: number;
  };
  
  /** Cumulative emissions across all years */
  cumulative_emissions: {
    value: number;
    unit: string;
  };
  
  /** Peak installed capacity */
  peak_capacity: {
    value: number;
    unit: string;
    year: number;
  };
  
  /** Total investment across all agents */
  total_investment: {
    value: number;
    unit: string;
  };
  
  /** Average prices by commodity */
  average_price: {
    commodity: string;
    value: number;
    unit: string;
  }[];
}
```

### Example

```json
{
  "total_emissions": {
    "value": 125000000,
    "unit": "tCO2e",
    "trend": "down",
    "delta_percent": -12.2
  },
  "cumulative_emissions": {
    "value": 3250000000,
    "unit": "tCO2e"
  },
  "peak_capacity": {
    "value": 18000,
    "unit": "MW",
    "year": 2045
  },
  "total_investment": {
    "value": 12500000000,
    "unit": "USD"
  },
  "average_price": [
    {
      "commodity": "electricity",
      "value": 65.5,
      "unit": "USD/MWh"
    },
    {
      "commodity": "hydrogen",
      "value": 3.2,
      "unit": "USD/kg"
    }
  ]
}
```

### Usage Notes

- `trend` is computed from first-to-last year comparison
- `delta_percent` is only present for scenario runs
- All values include units for unambiguous interpretation

---

## 3. drivers.json

Factors that drive the simulation results. Ranked by contribution to enable narrative prioritisation.

> **Note:** This schema matches the consolidated Driver interface from the web bundle schema (`docs/web_bundle_schema.md`). The `evidence` field is populated by story generation tools.

### Schema

```typescript
interface Driver {
  /** Factor name (e.g., "carbon_price", "capex_reduction") */
  factor: string;
  
  /** Relative contribution to outcome (0-1, normalised) */
  contribution: number;
  
  /** Direction of impact on primary outcome */
  direction: 'positive' | 'negative' | 'neutral';
  
  /** Human-readable explanation suitable for narrative */
  explanation: string;
  
  /** Related parameters from assumptions (can be empty) */
  related_params: string[];
  
  /** Related agent IDs (can be empty) */
  related_agents: string[];
  
  /** References to specific data points as evidence (populated by story generation) */
  evidence?: string[];
}

type Drivers = Driver[];
```

### Example

```json
[
  {
    "factor": "carbon_price",
    "contribution": 0.35,
    "direction": "positive",
    "explanation": "Rising carbon prices from $25/t in 2024 to $150/t by 2050 drove accelerated retirement of high-emission assets and triggered investment in low-carbon alternatives.",
    "evidence": [
      "Carbon price increased 6x over simulation period",
      "Electricity producer retirements peaked in 2035 when carbon price exceeded $75/t",
      "Hydrogen investment began 2028 when NPV turned positive"
    ]
  },
  {
    "factor": "capex_reduction",
    "contribution": 0.25,
    "direction": "positive",
    "explanation": "50% reduction in hydrogen production CAPEX enabled economic viability of green hydrogen by 2030, triggering a wave of investment.",
    "evidence": [
      "Electrolyser CAPEX fell from $2500/kW to $1250/kW",
      "First profitable hydrogen project commissioned 2030",
      "Hydrogen capacity grew 15x between 2030-2045"
    ]
  },
  {
    "factor": "demand_growth",
    "contribution": 0.20,
    "direction": "negative",
    "explanation": "Higher than expected industrial electricity demand increased overall system emissions despite supply-side decarbonisation.",
    "evidence": [
      "Industrial demand grew 4% annually vs 2% baseline",
      "Peak demand reached 280 GWh vs 250 GWh in baseline",
      "Supply-demand gap widened in 2035-2040 period"
    ]
  },
  {
    "factor": "investment_behaviour",
    "contribution": 0.15,
    "direction": "negative",
    "explanation": "Agent investment thresholds led to lumpy capacity additions, creating periodic supply-demand mismatches and price volatility.",
    "evidence": [
      "Investment clustered in 3-year cycles",
      "Price spikes observed in 2028, 2035, 2042",
      "Capacity additions lagged demand by 2-3 years"
    ]
  },
  {
    "factor": "technology_learning",
    "contribution": 0.05,
    "direction": "positive",
    "explanation": "Learning-by-doing effects reduced operating costs over time, improving project economics for early movers.",
    "evidence": [
      "O&M costs fell 20% between 2024-2040",
      "Capacity factors improved from 85% to 92%"
    ]
  }
]
```

### Usage Notes

- Drivers are pre-sorted by `contribution` (highest first)
- `contribution` values sum to 1.0 across all drivers
- `evidence` provides specific data points for LLM citation
- Limit to 5-7 drivers for narrative coherence

---

## 4. agent_summary.json

Aggregated agent behaviour across the simulation. Provides narrative about who did what.

### Schema

```typescript
interface AgentTypeSummary {
  /** Agent type identifier */
  type: string;
  
  /** Number of agents of this type */
  count: number;
  
  /** Number that made investment decisions */
  invest_count: number;
  
  /** Number that made retirement decisions */
  retire_count: number;
  
  /** Number that held steady (no major changes) */
  hold_count: number;
  
  /** Net capacity change for this type (MW) */
  total_capacity_change: number;
}

interface AgentSummary {
  /** Total number of agents in simulation */
  total_agents: number;
  
  /** Summary by agent type */
  by_type: AgentTypeSummary[];
  
  /** One-line description of dominant behaviour */
  dominant_behaviour: string;
  
  /** Notable patterns observed (for narrative highlights) */
  notable_patterns: string[];
}
```

### Example

```json
{
  "total_agents": 45,
  "by_type": [
    {
      "type": "ElectricityProducer",
      "count": 20,
      "invest_count": 12,
      "retire_count": 5,
      "hold_count": 3,
      "total_capacity_change": 8500
    },
    {
      "type": "HydrogenProducer",
      "count": 10,
      "invest_count": 8,
      "retire_count": 0,
      "hold_count": 2,
      "total_capacity_change": 3200
    },
    {
      "type": "IndustrialConsumer",
      "count": 12,
      "invest_count": 0,
      "retire_count": 0,
      "hold_count": 12,
      "total_capacity_change": 0
    },
    {
      "type": "Regulator",
      "count": 3,
      "invest_count": 0,
      "retire_count": 0,
      "hold_count": 3,
      "total_capacity_change": 0
    }
  ],
  "dominant_behaviour": "Heavy investment in electricity and hydrogen production capacity",
  "notable_patterns": [
    "Early adopters began investing from 2025, ahead of policy signals",
    "Hydrogen producers showed highest investment rate (80% of agents invested)",
    "Electricity retirements clustered around 2035 when carbon prices exceeded $75/t",
    "Industrial consumers maintained stable demand patterns throughout",
    "No hydrogen producer retired - all capacity additions were net new"
  ]
}
```

### Usage Notes

- `dominant_behaviour` is a single sentence for story lead
- `notable_patterns` provide narrative colour and highlights
- Agent counts enable "X of Y agents..." narrative framing

---

## 5. scenario_comparison.json

Comparison with baseline (only present for scenario runs). Enables comparative narrative.

### Schema

```typescript
interface KeyDifference {
  /** Metric being compared */
  metric: string;
  
  /** Value in baseline run */
  baseline_value: number;
  
  /** Value in this scenario run */
  scenario_value: number;
  
  /** Absolute difference (scenario - baseline) */
  delta: number;
  
  /** Percentage difference */
  delta_percent: number;
  
  /** Human-readable interpretation */
  interpretation: string;
}

interface AssumptionChange {
  /** Parameter that was changed */
  param: string;
  
  /** Region affected (null for global) */
  region: string | null;
  
  /** Value in baseline */
  baseline: number;
  
  /** Value in scenario */
  scenario: number;
  
  /** Rationale for the change */
  rationale: string;
}

interface ScenarioComparison {
  /** Reference to baseline run (null if baseline unavailable) */
  baseline_run_id: string | null;
  
  /** Key differences in outcomes */
  key_differences: KeyDifference[];
  
  /** Assumption changes that drove differences */
  assumption_changes: AssumptionChange[];
}
```

### Example

```json
{
  "baseline_run_id": "run_a1c2e3f4",
  "key_differences": [
    {
      "metric": "cumulative_emissions",
      "baseline_value": 3700000000,
      "scenario_value": 3250000000,
      "delta": -450000000,
      "delta_percent": -12.2,
      "interpretation": "The high ambition scenario reduces cumulative emissions by 450 Mt CO2e (12%) compared to baseline"
    },
    {
      "metric": "year_net_zero",
      "baseline_value": 0,
      "scenario_value": 2048,
      "delta": 2048,
      "delta_percent": 100,
      "interpretation": "The scenario achieves net-zero by 2048, whereas baseline never reaches net-zero within the simulation period"
    },
    {
      "metric": "total_investment",
      "baseline_value": 10000000000,
      "scenario_value": 12500000000,
      "delta": 2500000000,
      "delta_percent": 25,
      "interpretation": "Achieving the emissions reduction requires 25% more capital investment ($2.5B additional)"
    },
    {
      "metric": "average_electricity_price",
      "baseline_value": 70.5,
      "scenario_value": 65.5,
      "delta": -5.0,
      "delta_percent": -7.1,
      "interpretation": "Despite higher investment, average electricity prices are 7% lower due to cheaper renewable generation"
    }
  ],
  "assumption_changes": [
    {
      "param": "carbon_price",
      "region": null,
      "baseline": 50,
      "scenario": 100,
      "rationale": "High ambition carbon pricing pathway aligned with 1.5°C target"
    },
    {
      "param": "capex_hydrogen",
      "region": null,
      "baseline": 2500,
      "scenario": 1800,
      "rationale": "Accelerated electrolyser cost reduction from manufacturing scale-up"
    },
    {
      "param": "demand_growth",
      "region": "AUS",
      "baseline": 0.02,
      "scenario": 0.04,
      "rationale": "High industrial electrification scenario"
    }
  ]
}
```

### Usage Notes

- `baseline_run_id` is null if baseline results are unavailable
- `key_differences` are pre-sorted by `abs(delta_percent)` (most significant first)
- `interpretation` provides ready-to-use narrative text
- `assumption_changes` explain the "why" behind differences

---

## 6. caveats.json

Mandatory limitations and warnings. Must be included in any generated narrative.

### Schema

```typescript
interface Caveats {
  /** Fundamental model limitations */
  model_limitations: string[];
  
  /** Data quality and availability issues */
  data_limitations: string[];
  
  /** Caveats specific to this scenario */
  scenario_specific: string[];
  
  /** Guidance for interpreting results */
  interpretation_guidance: string[];
}
```

### Example

```json
{
  "model_limitations": [
    "This model uses simplified agent decision rules that do not capture all real-world investment considerations",
    "Technology learning curves are exogenous and do not respond to deployment volumes",
    "The model operates at annual resolution and does not capture intra-year dynamics",
    "Grid constraints and transmission limitations are not explicitly modelled",
    "Agent foresight is limited to a 3-year horizon, which may underestimate strategic behaviour"
  ],
  "data_limitations": [
    "Cost projections are based on IEA WEO 2023 central estimates with significant uncertainty",
    "Demand growth assumptions are extrapolated from historical trends",
    "Carbon price trajectories are policy assumptions, not forecasts",
    "Regional variations in costs and resources are not fully captured"
  ],
  "scenario_specific": [
    "The high ambition carbon price pathway assumes successful international climate negotiations",
    "Electrolyser cost reductions assume manufacturing scale-up that has not yet been demonstrated",
    "Industrial demand growth of 4% annually is at the upper end of analyst projections"
  ],
  "interpretation_guidance": [
    "Results should be interpreted as illustrative scenarios, not predictions",
    "Comparisons between scenarios are more robust than absolute values",
    "Sensitivity to key assumptions should be explored before policy conclusions",
    "Emissions trajectories are contingent on assumed policy frameworks remaining in place"
  ]
}
```

### Usage Notes

- All four categories should be present (may be empty arrays)
- LLM must include at least one caveat from each non-empty category
- `scenario_specific` caveats are only populated for scenario runs
- Caveats should be concise but complete

---

## Alignment with Web Bundle

Story data products are derived from the web bundle with the following mappings:

| Story Data Product | Web Bundle Source | Transformation |
|--------------------|-------------------|----------------|
| `story_context` | `manifest.json` | Extract + add audience |
| `headline_metrics` | `summary.json` | Restructure + add trends |
| `drivers` | `drivers.json` | Add evidence strings |
| `agent_summary` | `agents.json` + `agent_traces.json` | Aggregate across traces |
| `scenario_comparison` | `scenario_diff.json` + `summary.json` | Merge + interpret |
| `caveats` | Generated | Context-aware generation |

---

## Python Type Definitions

Python dataclass equivalents are provided in `src/agent_zero/story/types.py` for use by story generation tools.

---

## Validation

Story data products can be validated with:

```bash
agentzero validate-story --run-dir runs/<run_id>
```

This checks:
- All required files are present
- JSON is valid and parseable
- Required fields are present in each schema
- Type constraints are satisfied
- Cross-references are consistent with source web bundle
